name: Version Bump and Release

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'ç‰ˆæœ¬å·ç±»å‹'
        required: true
        default: 'auto'
        type: choice
        options:
          - auto
          - manual
      new_version:
        description: 'æ–°ç‰ˆæœ¬å· (ä¾‹å¦‚: 0.4.21) - ä»…åœ¨ç‰ˆæœ¬å·ç±»å‹é€‰æ‹©"manual"æ—¶éœ€è¦'
        required: false
        type: string
      push_to_main:
        description: 'è‡ªåŠ¨æ¨é€åˆ° main åˆ†æ”¯'
        required: true
        default: true
        type: boolean
      create_tag:
        description: 'è‡ªåŠ¨åˆ›å»ºå¹¶æ¨é€æ ‡ç­¾'
        required: true
        default: true
        type: boolean

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  version-bump:
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.version.outputs.new_version }}
      bumped: ${{ steps.version.outputs.bumped }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          # ä¸æŒ‡å®š refï¼Œè®©å·¥ä½œæµåœ¨é»˜è®¤åˆ†æ”¯ä¸Šè¿è¡Œï¼Œç„¶ååˆ›å»ºdevåˆ†æ”¯

      - name: é…ç½® Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: è·å–å½“å‰ç‰ˆæœ¬å·
        id: current_version
        run: |
          # ä» package.json è·å–å½“å‰ç‰ˆæœ¬å·
          CURRENT_VERSION=$(node -p "require('./GitMentor-Lite/package.json').version")
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "å½“å‰ç‰ˆæœ¬: $CURRENT_VERSION"

      - name: è®¡ç®—æ–°ç‰ˆæœ¬å·
        id: version
        run: |
          CURRENT_VERSION="${{ steps.current_version.outputs.current_version }}"
          VERSION_TYPE="${{ github.event.inputs.version_type }}"
          NEW_VERSION="${{ github.event.inputs.new_version }}"

          if [ "$VERSION_TYPE" == "manual" ]; then
            if [ -z "$NEW_VERSION" ]; then
              echo "âŒ å½“é€‰æ‹©æ‰‹åŠ¨ç‰ˆæœ¬å·æ—¶ï¼Œå¿…é¡»æä¾›æ–°ç‰ˆæœ¬å·"
              exit 1
            fi
            echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
            echo "bumped=true" >> $GITHUB_OUTPUT
            echo "ä½¿ç”¨æ‰‹åŠ¨æŒ‡å®šçš„ç‰ˆæœ¬å·: $NEW_VERSION"
          else
            # è‡ªåŠ¨é€’å¢ç‰ˆæœ¬å·
            # å°†ç‰ˆæœ¬å·åˆ†å‰²ä¸ºä¸»ç‰ˆæœ¬ã€æ¬¡ç‰ˆæœ¬ã€è¡¥ä¸ç‰ˆæœ¬
            IFS='.' read -ra VERSION_PARTS <<< "$CURRENT_VERSION"
            MAJOR=${VERSION_PARTS[0]}
            MINOR=${VERSION_PARTS[1]}
            PATCH=${VERSION_PARTS[2]}

            # å¢åŠ è¡¥ä¸ç‰ˆæœ¬å·
            PATCH=$((PATCH + 1))

            NEW_VERSION="$MAJOR.$MINOR.$PATCH"
            echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
            echo "bumped=true" >> $GITHUB_OUTPUT
            echo "è‡ªåŠ¨é€’å¢ç‰ˆæœ¬å·: $CURRENT_VERSION -> $NEW_VERSION"
          fi

      - name: æ›´æ–° package.json
        run: |
          NEW_VERSION="${{ steps.version.outputs.new_version }}"
          echo "æ›´æ–° package.json ç‰ˆæœ¬å·åˆ°: $NEW_VERSION"

          # ä½¿ç”¨ Node.js æ›´æ–° package.json
          node -e "
            const fs = require('fs');
            const packageJson = JSON.parse(fs.readFileSync('./GitMentor-Lite/package.json', 'utf8'));
            packageJson.version = '$NEW_VERSION';
            fs.writeFileSync('./GitMentor-Lite/package.json', JSON.stringify(packageJson, null, 2) + '\n');
            console.log('âœ… package.json å·²æ›´æ–°');
          "

      - name: æ›´æ–° Cargo.toml
        run: |
          NEW_VERSION="${{ steps.version.outputs.new_version }}"
          echo "æ›´æ–° Cargo.toml ç‰ˆæœ¬å·åˆ°: $NEW_VERSION"

          # ä½¿ç”¨ sed æ›´æ–° Cargo.toml
          sed -i 's/^version = .*/version = "'$NEW_VERSION'"/' GitMentor-Lite/src-tauri/Cargo.toml
          echo "âœ… Cargo.toml å·²æ›´æ–°"

      - name: æ›´æ–° tauri.conf.json
        run: |
          NEW_VERSION="${{ steps.version.outputs.new_version }}"
          echo "æ›´æ–° tauri.conf.json ç‰ˆæœ¬å·åˆ°: $NEW_VERSION"

          # ä½¿ç”¨ Node.js æ›´æ–° tauri.conf.json
          node -e "
            const fs = require('fs');
            const config = JSON.parse(fs.readFileSync('./GitMentor-Lite/src-tauri/tauri.conf.json', 'utf8'));
            config.version = '$NEW_VERSION';
            fs.writeFileSync('./GitMentor-Lite/src-tauri/tauri.conf.json', JSON.stringify(config, null, 2) + '\n');
            console.log('âœ… tauri.conf.json å·²æ›´æ–°');
          "

      - name: éªŒè¯ç‰ˆæœ¬å·æ›´æ–°
        run: |
          echo "éªŒè¯ç‰ˆæœ¬å·æ›´æ–°..."
          echo ""
          echo "ğŸ“¦ package.json: $(node -p "require('./GitMentor-Lite/package.json').version")"
          echo "ğŸ“¦ Cargo.toml: $(grep '^version = ' GitMentor-Lite/src-tauri/Cargo.toml | cut -d'"' -f2)"
          echo "ğŸ“¦ tauri.conf.json: $(node -p "require('./GitMentor-Lite/src-tauri/tauri.conf.json').version")"
          echo ""

      - name: åˆ›å»ºdevåˆ†æ”¯å¹¶æäº¤ç‰ˆæœ¬å·æ›´æ”¹
        if: steps.version.outputs.bumped == 'true'
        run: |
          NEW_VERSION="${{ steps.version.outputs.new_version }}"
          # å¼ºåˆ¶åˆ é™¤æœ¬åœ°devåˆ†æ”¯ï¼ˆå¦‚æœå­˜åœ¨ï¼‰å¹¶é‡æ–°åˆ›å»º
          git branch -D dev 2>/dev/null || true
          # åˆ›å»ºdevåˆ†æ”¯å¹¶åˆ‡æ¢è¿‡å»
          git checkout -b dev
          # æ·»åŠ å¹¶æäº¤ç‰ˆæœ¬å·æ›´æ”¹åˆ°devåˆ†æ”¯
          git add GitMentor-Lite/package.json GitMentor-Lite/src-tauri/Cargo.toml GitMentor-Lite/src-tauri/tauri.conf.json
          git commit -m "chore: bump version to v$NEW_VERSION

          ğŸ¤– Generated with [Claude Code](https://claude.com/claude-code)

          Co-Authored-By: github-actions[bot] <github-actions[bot]@users.noreply.github.com>" || echo "æ²¡æœ‰æ›´æ”¹éœ€è¦æäº¤"
          # æ¨é€åˆ°è¿œç¨‹devåˆ†æ”¯
          git push -f origin dev

  merge-to-main:
    needs: version-bump
    runs-on: ubuntu-latest
    if: github.event.inputs.push_to_main == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          # ä»devåˆ†æ”¯æ£€å‡ºä»¥åˆ›å»ºPR
          ref: dev

      - name: é…ç½® Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/keliveshd/GitMentor.git

      - name: åˆ›å»º Pull Request
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: bump version to v${{ needs.version-bump.outputs.new_version }}"
          title: "ğŸš€ ç‰ˆæœ¬å‘å¸ƒ v${{ needs.version-bump.outputs.new_version }}"
          body: |
            ## ğŸ“¦ ç‰ˆæœ¬å‘å¸ƒ

            **æ–°ç‰ˆæœ¬å·ï¼š** v${{ needs.version-bump.outputs.new_version }}

            ### å˜æ›´å†…å®¹
            - è‡ªåŠ¨é€’å¢ç‰ˆæœ¬å·
            - æ›´æ–° `package.json` ç‰ˆæœ¬
            - æ›´æ–° `Cargo.toml` ç‰ˆæœ¬
            - æ›´æ–° `tauri.conf.json` ç‰ˆæœ¬

            ### åç»­æ­¥éª¤
            - [ ] PR åˆå¹¶åï¼Œæ ‡ç­¾åˆ›å»ºå·¥ä½œæµå°†è‡ªåŠ¨è§¦å‘
            - [ ] æ„å»ºå·¥ä½œæµå°†è‡ªåŠ¨è¿è¡Œ

            ---
            ğŸ¤– æ­¤ PR ç”±è‡ªåŠ¨åŒ–å·¥ä½œæµç”Ÿæˆ
          branch: release/v${{ needs.version-bump.outputs.new_version }}
          base: main

      - name: æ˜¾ç¤ºç»“æœ
        run: |
          NEW_VERSION="${{ needs.version-bump.outputs.new_version }}"
          echo ""
          echo "================================================"
          echo "ğŸš€ Pull Request å·²åˆ›å»ºï¼"
          echo "================================================"
          echo "ğŸ“¦ ç‰ˆæœ¬å·: $NEW_VERSION"
          echo "ğŸ“ PR åˆ†æ”¯: release/v$NEW_VERSION"
          echo "ğŸ”— PR é“¾æ¥: https://github.com/keliveshd/GitMentor/compare/main...release/v$NEW_VERSION"
          echo ""
          echo "æ¥ä¸‹æ¥çš„æ­¥éª¤ï¼š"
          echo "1. è¯·æ‰‹åŠ¨åˆå¹¶æ­¤ PR åˆ° main åˆ†æ”¯"
          echo "2. åˆå¹¶åï¼Œå†æ¬¡è¿è¡Œæ­¤å·¥ä½œæµåˆ›å»ºæ ‡ç­¾"
          echo "3. æ ‡ç­¾åˆ›å»ºåå°†è‡ªåŠ¨è§¦å‘æ„å»ºå·¥ä½œæµ"
          echo "================================================"

  create-and-push-tag:
    runs-on: ubuntu-latest
    if: github.event.inputs.create_tag == 'true'
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
          ref: main

      - name: é…ç½® Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/keliveshd/GitMentor.git

      - name: éªŒè¯ç‰ˆæœ¬å’Œæ£€æŸ¥PRçŠ¶æ€
        run: |
          # è·å–mainåˆ†æ”¯ç‰ˆæœ¬
          NEW_VERSION=$(node -p "require('./GitMentor-Lite/package.json').version")
          TAG_NAME="v$NEW_VERSION"

          echo "ğŸ“¦ å½“å‰ main åˆ†æ”¯ç‰ˆæœ¬: $NEW_VERSION"
          echo "ğŸ·ï¸  å‡†å¤‡åˆ›å»ºæ ‡ç­¾: $TAG_NAME"
          echo ""

          # è·å–devåˆ†æ”¯ç‰ˆæœ¬
          git fetch origin dev --no-recurse-submodules
          DEV_VERSION=$(git show origin/dev:GitMentor-Lite/package.json | node -p "JSON.parse(require('fs').readFileSync('/dev/stdin', 'utf8')).version")
          echo "ğŸ“¦ dev åˆ†æ”¯ç‰ˆæœ¬: $DEV_VERSION"
          echo ""

          # æ£€æŸ¥PRæ˜¯å¦å·²åˆå¹¶ - å¦‚æœdevç‰ˆæœ¬ > mainç‰ˆæœ¬ï¼Œè¯´æ˜PRæ²¡æœ‰åˆå¹¶
          if [ "$(printf '%s\n' "$NEW_VERSION" "$DEV_VERSION" | sort -V | head -n1)" != "$NEW_VERSION" ]; then
            echo "âŒ é”™è¯¯ï¼šdev åˆ†æ”¯ç‰ˆæœ¬ ($DEV_VERSION) é«˜äº main åˆ†æ”¯ç‰ˆæœ¬ ($NEW_VERSION)"
            echo ""
            echo "è¿™è¡¨æ˜ Pull Request å°šæœªåˆå¹¶åˆ° main åˆ†æ”¯ï¼"
            echo ""
            echo "è¯·å…ˆåˆå¹¶ä»¥ä¸‹ PR åˆ° main åˆ†æ”¯ï¼š"
            echo "ğŸ”— https://github.com/keliveshd/GitMentor/pulls"
            echo ""
            echo "æˆ–è€…è¯·å…ˆè¿è¡Œç¬¬ä¸€æ¬¡å·¥ä½œæµåˆ›å»ºPRï¼š"
            echo "- ç‰ˆæœ¬å·ç±»å‹: auto"
            echo "- æ¨é€åˆ° main åˆ†æ”¯: âœ… å‹¾é€‰"
            echo "- åˆ›å»ºæ ‡ç­¾: âŒ ä¸å‹¾é€‰"
            exit 1
          fi

          # æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å·²å­˜åœ¨
          if git ls-remote --tags origin | grep -q "refs/tags/$TAG_NAME"; then
            echo "âŒ é”™è¯¯ï¼šæ ‡ç­¾ $TAG_NAME å·²å­˜åœ¨ï¼"
            echo ""
            echo "æ­¤ç‰ˆæœ¬å·²ç»å‘å¸ƒè¿‡ã€‚è¯·æŸ¥çœ‹ï¼š"
            echo "ğŸ”— æŸ¥çœ‹ Releases: https://github.com/keliveshd/GitMentor/releases"
            exit 1
          fi

          echo "âœ… PR å·²åˆå¹¶ï¼Œæ ‡ç­¾ä¸å­˜åœ¨ï¼Œå¯ä»¥åˆ›å»º"

      - name: åˆ›å»ºå¹¶æ¨é€æ ‡ç­¾
        run: |
          NEW_VERSION=$(node -p "require('./GitMentor-Lite/package.json').version")
          TAG_NAME="v$NEW_VERSION"

          echo "ğŸ·ï¸  åˆ›å»ºæ ‡ç­¾: $TAG_NAME"
          git tag -a "$TAG_NAME" -m "Release $TAG_NAME"
          git push origin "$TAG_NAME"

          echo "âœ… æ ‡ç­¾ $TAG_NAME å·²åˆ›å»ºå¹¶æ¨é€åˆ°è¿œç¨‹"

      - name: æ˜¾ç¤ºç»“æœ
        run: |
          NEW_VERSION=$(node -p "require('./GitMentor-Lite/package.json').version")
          echo ""
          echo "================================================"
          echo "ğŸ‰ æ ‡ç­¾åˆ›å»ºå®Œæˆï¼"
          echo "================================================"
          echo "ğŸ“¦ æ–°ç‰ˆæœ¬å·: $NEW_VERSION"
          echo "ğŸ·ï¸  æ ‡ç­¾: v$NEW_VERSION"
          echo "ğŸŒ¿ åˆ†æ”¯: main"
          echo ""
          echo "æ¥ä¸‹æ¥çš„æ­¥éª¤ï¼š"
          echo "1. 'Release Build and Publish' å·¥ä½œæµå°†è‡ªåŠ¨è§¦å‘æ„å»º"
          echo "2. æ„å»ºå®Œæˆåä¼šåœ¨ GitHub Releases ä¸­åˆ›å»ºå‘å¸ƒ"
          echo ""
          echo "ğŸ”— æŸ¥çœ‹ Releases: https://github.com/keliveshd/GitMentor/releases"
          echo "================================================"
