name: 'Draft Release'

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string
      prerelease:
        description: 'Is this a pre-release?'
        required: false
        default: false
        type: boolean

jobs:
  create-draft:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate version format
        run: |
          if [[ ! "${{ github.event.inputs.version }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+)?$ ]]; then
            echo "é”™è¯¯: ç‰ˆæœ¬æ ¼å¼ä¸æ­£ç¡®ã€‚åº”è¯¥æ˜¯ vX.Y.Z æˆ– vX.Y.Z-suffix æ ¼å¼"
            exit 1
          fi

      - name: Check if tag exists
        run: |
          if git rev-parse "${{ github.event.inputs.version }}" >/dev/null 2>&1; then
            echo "é”™è¯¯: æ ‡ç­¾ ${{ github.event.inputs.version }} å·²å­˜åœ¨"
            exit 1
          fi

      - name: Update version in files
        run: |
          VERSION="${{ github.event.inputs.version }}"
          VERSION_NUMBER="${VERSION#v}"  # ç§»é™¤ v å‰ç¼€
          
          echo "æ›´æ–°ç‰ˆæœ¬å·åˆ° $VERSION_NUMBER"
          
          # æ›´æ–° package.json
          sed -i "s/\"version\": \".*\"/\"version\": \"$VERSION_NUMBER\"/" GitMentor-Lite/package.json
          
          # æ›´æ–° Cargo.toml
          sed -i "s/version = \".*\"/version = \"$VERSION_NUMBER\"/" GitMentor-Lite/src-tauri/Cargo.toml
          
          # æ›´æ–° tauri.conf.json
          sed -i "s/\"version\": \".*\"/\"version\": \"$VERSION_NUMBER\"/" GitMentor-Lite/src-tauri/tauri.conf.json

      - name: Generate changelog
        id: changelog
        run: |
          echo "ç”Ÿæˆæ›´æ–°æ—¥å¿—..."
          
          # èŽ·å–æœ€æ–°çš„æ ‡ç­¾
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [ -z "$LATEST_TAG" ]; then
            echo "è¿™æ˜¯ç¬¬ä¸€ä¸ªç‰ˆæœ¬"
            CHANGELOG="## ðŸŽ‰ é¦–æ¬¡å‘å¸ƒ

### âœ¨ ä¸»è¦åŠŸèƒ½
- AI é©±åŠ¨çš„ Git æäº¤æ¶ˆæ¯ç”Ÿæˆ
- æ”¯æŒå¤šç§ AI æä¾›å•†ï¼ˆOpenAIã€Claudeã€Gemini ç­‰ï¼‰
- åˆ†å±‚æäº¤ç®¡ç†ç³»ç»Ÿ
- å¤šè¯­è¨€æ”¯æŒï¼ˆ19ç§è¯­è¨€ï¼‰
- åˆ†æ”¯åˆ‡æ¢å’Œè¿œç¨‹åŒæ­¥
- ç›´è§‚çš„ç”¨æˆ·ç•Œé¢

### ðŸ”§ æŠ€æœ¯ç‰¹æ€§
- åŸºäºŽ Tauri v2 çš„è·¨å¹³å°æ¡Œé¢åº”ç”¨
- Vue 3 + TypeScript å‰ç«¯
- Rust åŽç«¯
- æ”¯æŒ Windowsã€macOSã€Linux

### ðŸ“¦ å®‰è£…è¯´æ˜Ž
è¯·æ ¹æ®æ‚¨çš„æ“ä½œç³»ç»Ÿä¸‹è½½å¯¹åº”çš„å®‰è£…åŒ…ï¼š
- Windows: ä¸‹è½½ .msi æ–‡ä»¶
- macOS: ä¸‹è½½ .dmg æ–‡ä»¶  
- Linux: ä¸‹è½½ .debã€.rpm æˆ– .AppImage æ–‡ä»¶"
          else
            echo "ç”Ÿæˆä»Ž $LATEST_TAG åˆ°å½“å‰çš„æ›´æ–°æ—¥å¿—"
            CHANGELOG="## ðŸš€ æ›´æ–°å†…å®¹

$(git log $LATEST_TAG..HEAD --pretty=format:"- %s" --no-merges)

### ðŸ“¦ ä¸‹è½½è¯´æ˜Ž
è¯·æ ¹æ®æ‚¨çš„æ“ä½œç³»ç»Ÿä¸‹è½½å¯¹åº”çš„å®‰è£…åŒ…ï¼š
- **Windows**: ä¸‹è½½ \`.msi\` å®‰è£…åŒ…
- **macOS**: ä¸‹è½½ \`.dmg\` ç£ç›˜æ˜ åƒ
- **Linux**: ä¸‹è½½ \`.deb\` (Ubuntu/Debian) æˆ– \`.rpm\` (CentOS/RHEL) æˆ– \`.AppImage\` (é€šç”¨)

### ðŸ”§ ç³»ç»Ÿè¦æ±‚
- Node.js 16+
- Git 2.30+
- æ”¯æŒçš„æ“ä½œç³»ç»Ÿï¼šWindows 10+, macOS 10.15+, Ubuntu 20.04+"
          fi
          
          # ä¿å­˜åˆ°æ–‡ä»¶
          echo "$CHANGELOG" > changelog.md
          
          # è¾“å‡ºåˆ° GitHub Actions
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create draft release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.event.inputs.version }}
          release_name: GitMentor ${{ github.event.inputs.version }}
          body: ${{ steps.changelog.outputs.changelog }}
          draft: true
          prerelease: ${{ github.event.inputs.prerelease }}

      - name: Commit version changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add GitMentor-Lite/package.json GitMentor-Lite/src-tauri/Cargo.toml GitMentor-Lite/src-tauri/tauri.conf.json
          git commit -m "chore: bump version to ${{ github.event.inputs.version }}" || exit 0
          git push

      - name: Create and push tag
        run: |
          git tag ${{ github.event.inputs.version }}
          git push origin ${{ github.event.inputs.version }}

      - name: Summary
        run: |
          echo "## ðŸŽ‰ è‰ç¨¿å‘å¸ƒå·²åˆ›å»º" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬**: ${{ github.event.inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **é¢„å‘å¸ƒ**: ${{ github.event.inputs.prerelease }}" >> $GITHUB_STEP_SUMMARY
          echo "- **çŠ¶æ€**: è‰ç¨¿ (éœ€è¦æ‰‹åŠ¨å‘å¸ƒ)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ ä¸‹ä¸€æ­¥æ“ä½œ" >> $GITHUB_STEP_SUMMARY
          echo "1. æ£€æŸ¥è‰ç¨¿å‘å¸ƒçš„å†…å®¹" >> $GITHUB_STEP_SUMMARY
          echo "2. ç­‰å¾…æž„å»ºå·¥ä½œæµå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "3. éªŒè¯æž„å»ºäº§ç‰©" >> $GITHUB_STEP_SUMMARY
          echo "4. å‘å¸ƒè‰ç¨¿ç‰ˆæœ¬" >> $GITHUB_STEP_SUMMARY
