name: "Draft Release"

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g., v1.0.0)"
        required: true
        type: string
      prerelease:
        description: "Is this a pre-release?"
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  packages: write

jobs:
  create-draft:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Validate version format
        run: |
          if [[ ! "${{ github.event.inputs.version }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+)?$ ]]; then
            echo "é”™è¯¯: ç‰ˆæœ¬æ ¼å¼ä¸æ­£ç¡®ã€‚åº”è¯¥æ˜¯ vX.Y.Z æˆ– vX.Y.Z-suffix æ ¼å¼"
            exit 1
          fi

      - name: Check if tag exists
        run: |
          if git rev-parse "${{ github.event.inputs.version }}" >/dev/null 2>&1; then
            echo "é”™è¯¯: æ ‡ç­¾ ${{ github.event.inputs.version }} å·²å­˜åœ¨"
            exit 1
          fi

      - name: Update version in files
        run: |
          VERSION="${{ github.event.inputs.version }}"
          VERSION_NUMBER="${VERSION#v}"  # ç§»é™¤ v å‰ç¼€

          echo "æ›´æ–°ç‰ˆæœ¬å·åˆ° $VERSION_NUMBER"

          # æ›´æ–° package.json
          npm version $VERSION_NUMBER --no-git-tag-version --prefix GitMentor-Lite

          # æ›´æ–° Cargo.toml (åªæ›´æ–°ç¬¬3è¡Œçš„ç‰ˆæœ¬ï¼Œè¿™æ˜¯ [package] éƒ¨åˆ†çš„ç‰ˆæœ¬)
          cd GitMentor-Lite/src-tauri
          # ä½¿ç”¨è¡Œå·ç²¾ç¡®æ›´æ–°ï¼Œé¿å…è¯¯ä¿®æ”¹ä¾èµ–ç‰ˆæœ¬
          sed -i "3s/version = .*/version = \"$VERSION_NUMBER\"/" Cargo.toml

          # æ›´æ–° tauri.conf.json
          cd ../..
          sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION_NUMBER\"/" GitMentor-Lite/src-tauri/tauri.conf.json

      - name: Generate changelog
        id: changelog
        run: |
          echo "ç”Ÿæˆæ›´æ–°æ—¥å¿—..."
          CHANGELOG="GitMentor å‘å¸ƒ - AI é©±åŠ¨çš„ Git æäº¤æ¶ˆæ¯ç”Ÿæˆå·¥å…·"
          echo "changelog=$CHANGELOG" >> $GITHUB_OUTPUT

      - name: Create draft release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.event.inputs.version }}
          release_name: GitMentor ${{ github.event.inputs.version }}
          body: ${{ steps.changelog.outputs.changelog }}
          draft: true
          prerelease: ${{ github.event.inputs.prerelease }}

      - name: Create release branch and PR
        run: |
          BRANCH="release/${{ github.event.inputs.version }}"
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git checkout -b $BRANCH
          git add GitMentor-Lite/package.json GitMentor-Lite/src-tauri/Cargo.toml GitMentor-Lite/src-tauri/tauri.conf.json
          git commit -m "chore: bump version to ${{ github.event.inputs.version }}"
          git push origin $BRANCH

          echo "::notice::Created release branch: $BRANCH"
          echo "::notice::Please create a pull request to merge version changes"

      - name: Create tag (after PR merge)
        run: |
          echo "::notice::After merging the PR, manually create tag:"
          echo "::notice::git tag ${{ github.event.inputs.version }}"
          echo "::notice::git push origin ${{ github.event.inputs.version }}"

      - name: Summary
        run: |
          echo "## ðŸŽ‰ è‰ç¨¿å‘å¸ƒå·²åˆ›å»º" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ç‰ˆæœ¬**: ${{ github.event.inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **é¢„å‘å¸ƒ**: ${{ github.event.inputs.prerelease }}" >> $GITHUB_STEP_SUMMARY
          echo "- **çŠ¶æ€**: è‰ç¨¿ (éœ€è¦æ‰‹åŠ¨å‘å¸ƒ)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ ä¸‹ä¸€æ­¥æ“ä½œ" >> $GITHUB_STEP_SUMMARY
          echo "1. æ£€æŸ¥è‰ç¨¿å‘å¸ƒçš„å†…å®¹" >> $GITHUB_STEP_SUMMARY
          echo "2. ç­‰å¾…æž„å»ºå·¥ä½œæµå®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "3. éªŒè¯æž„å»ºäº§ç‰©" >> $GITHUB_STEP_SUMMARY
          echo "4. å‘å¸ƒè‰ç¨¿ç‰ˆæœ¬" >> $GITHUB_STEP_SUMMARY
