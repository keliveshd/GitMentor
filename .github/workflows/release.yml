name: Release Build and Publish

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      prerelease:
        description: '标记为预发布版本'
        required: true
        default: false
        type: boolean

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  build:
    permissions:
      contents: write
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: 安装 Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          cache: 'npm'
          cache-dependency-path: 'GitMentor-Lite/package-lock.json'

      - name: 安装 Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: 'x86_64-pc-windows-msvc'

      - name: 安装前端依赖
        run: npm ci
        working-directory: ./GitMentor-Lite

      - name: 构建前端
        run: npm run build
        shell: bash
        working-directory: ./GitMentor-Lite

      - name: 安装 Tauri CLI
        run: npm install @tauri-apps/cli@latest --save-dev
        working-directory: ./GitMentor-Lite

      - name: 构建 Tauri 应用（仅 MSI）
        run: |
          Write-Host "=== 开始构建 Tauri 应用 ===" -ForegroundColor Green
          npx tauri build --target x86_64-pc-windows-msvc --verbose
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        working-directory: ./GitMentor-Lite

      - name: 验证构建输出
        shell: pwsh
        run: |
          Write-Host "=== 验证构建输出 ===" -ForegroundColor Green
          $ReleaseDir = "GitMentor-Lite/src-tauri/target/x86_64-pc-windows-msvc/release"
          if (Test-Path $ReleaseDir) {
            Write-Host "✅ Release 目录存在" -ForegroundColor Green
            Get-ChildItem -Path $ReleaseDir -Name | ForEach-Object { Write-Host "  - $_" -ForegroundColor Cyan }
          } else {
            Write-Error "❌ Release 目录不存在"
            exit 1
          }

          $ExePath = "$ReleaseDir/GitMentorLite.exe"
          if (Test-Path $ExePath) {
            Write-Host "✅ 找到 GitMentorLite.exe" -ForegroundColor Green
            $size = (Get-Item $ExePath).Length / 1MB
            Write-Host "  文件大小: $([math]::Round($size, 2)) MB" -ForegroundColor Cyan
          } else {
            Write-Error "❌ 未找到 GitMentorLite.exe"
            exit 1
          }

      - name: 创建便携版 ZIP
        shell: pwsh
        run: |
          Write-Host "=== 创建便携版 ZIP ===" -ForegroundColor Green

          # 获取版本号
          $Version = "${{ github.ref_name }}".Replace('v', '')
          Write-Host "版本: $Version" -ForegroundColor Yellow

          # 设置路径
          $ReleaseDir = "GitMentor-Lite/src-tauri/target/x86_64-pc-windows-msvc/release"
          $PortableDir = "portable-temp/GitMentorLite-$Version"

          # 创建便携版目录
          if (Test-Path $PortableDir) { Remove-Item $PortableDir -Recurse -Force }
          New-Item -ItemType Directory -Path $PortableDir -Force | Out-Null

          # 复制文件
          Write-Host "复制可执行文件..." -ForegroundColor Cyan
          Copy-Item "$ReleaseDir/GitMentorLite.exe" $PortableDir

          if (Test-Path "$ReleaseDir/git.exe") {
            Write-Host "复制 git.exe..." -ForegroundColor Cyan
            Copy-Item "$ReleaseDir/git.exe" $PortableDir
          }

          if (Test-Path "$ReleaseDir/resources") {
            Write-Host "复制 resources..." -ForegroundColor Cyan
            Copy-Item "$ReleaseDir/resources" "$PortableDir/resources" -Recurse
          }

          # 创建启动脚本
          Write-Host "创建启动脚本..." -ForegroundColor Cyan
          $launcher = "@echo off`n"
          $launcher += "echo 启动 GitMentor Lite...`n"
          $launcher += 'start "" "GitMentorLite.exe"'
          $launcher | Out-File "$PortableDir/启动 GitMentor Lite.bat" -Encoding UTF8

          # 创建 README
          Write-Host "创建 README..." -ForegroundColor Cyan
          $readme = "# GitMentor Lite Portable v$Version`n`n使用方法：双击 `启动 GitMentor Lite.bat`"
          $readme | Out-File "$PortableDir/README.txt" -Encoding UTF8

          # 创建 ZIP
          Write-Host "创建 ZIP 包..." -ForegroundColor Cyan
          $zipPath = "GitMentorLite-$Version.zip"
          Compress-Archive -Path "$PortableDir\*" -DestinationPath $zipPath -CompressionLevel Optimal

          # 验证
          if (Test-Path $zipPath) {
            $size = (Get-Item $zipPath).Length / 1MB
            Write-Host "✅ ZIP 创建成功: $zipPath ($([math]::Round($size, 2)) MB)" -ForegroundColor Green
          } else {
            Write-Error "❌ ZIP 创建失败"
            exit 1
          }

          # 列出当前目录所有文件以便调试
          Write-Host "当前目录文件列表:" -ForegroundColor Yellow
          Get-ChildItem -Name *.zip, *.msi | ForEach-Object { Write-Host "  - $_" -ForegroundColor Cyan }

      - name: 上传到 GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            GitMentor-Lite/src-tauri/target/release/bundle/msi/*.msi
            GitMentorLite-*.zip
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  create-changelog:
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: write
    if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 生成 CHANGELOG
        id: changelog
        run: |
          # 获取上一个标签
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          echo "previous_tag=$PREVIOUS_TAG" >> $GITHUB_OUTPUT

          # 使用 git-cliff 生成 CHANGELOG
          if [ -f "cliff.toml" ]; then
            cargo install git-cliff
            git-cliff --latest --output CHANGELOG.md
          else
            # 简单的 CHANGELOG 生成
            cat > CHANGELOG.md << EOF
            # Changelog

            所有重要的更改都会记录在此文件中。

            ## [${{ github.ref_name }}] - $(date +%Y-%m-%d)

            ### 新功能
            - 支持 Portable 版本更新
            - 避免 PowerShell 脚本被杀毒软件拦截

            ### 更改
            - 使用 ZIP 包进行覆盖更新
            - 保留原有 MSI 安装方式

            EOF
          fi

      - name: 更新 Release 说明
        if: steps.changelog.outputs.previous_tag != ''
        uses: softprops/action-gh-release@v1
        with:
          body_path: CHANGELOG.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
